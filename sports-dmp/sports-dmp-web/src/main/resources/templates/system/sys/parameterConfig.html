<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>参数配置</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta http-equiv="pragma" content="no-cache" />
		<meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="/assets/common/layui/css/layui.css" media="all" />
		<link rel="stylesheet" href="/assets/common/css/public.css" media="all" />
		<link rel="stylesheet" href="/assets/system/common/css/font-awesome.min.css" media="all" />
		<style>
			.layui-form-item .layui-input-inline {
				margin-right: 0
			}
			
			.layui-form-label {
				padding: 9px 10px 0 0;
			}
			
			.layui-form-item {
				margin-bottom: 10px
			}
			.width180{
				width:180px!important;
			}
			.width180 input{
				width:180px!important;
			}
			table{
			width:100%!important;
			}
			.width80{
				width:80px!important;
			}
			.width80 input{
				width:80px!important;
			}
			tr td:first-child{
				width:30%;
			}
			tr td:last-child{
				width:70%;
				padding:0;
				font-size:0;
			}
			.fa{
				margin-left:5px;
			}
			.right{
				width:100%;
				line-height:28px;
				border:0;
				font-size:14px;
				box-sizing: border-box;
				padding-left:15px;
				background:transparent;
			    -webkit-box-sizing:-webkit-border-box;
				-moz-box-sizing:-moz-border-box;
				-ms-box-sizing:-ms-border-box;
			}
			.photo{
				border:1px solid #ccc;
				width: 100px;
			    height: 100px;
			    border-radius: 100px;
			}
			
			input:-webkit-autofill, textarea:-webkit-autofill, select:-webkit-autofill {
			    background-color:#fff!important;
			    background-image: none;
			    color: rgb(0, 0, 0);
			}
		</style>
	</head>

	<body class="childrenBody">
		<div id="app">
		 	<div class="layui-tab layui-tab-card" >
			  <ul class="layui-tab-title">
			    <li class="layui-this">基本信息配置</li>
			    <li>系统安全配置</li>
			    <li>系统邮箱</li>
			  </ul>
			  <div class="layui-tab-content">
			    <div class="layui-tab-item layui-show">
			    	<div class="layui-item" style="text-align:right">
			    		<!-- <button class="layui-btn">修改</button> -->
			    		<button class="layui-btn" id="save" @click="save">保存</button>
			    	</div>
					<form>
						<table class="layui-table">
							<tbody>
								<tr>
									<td >
										<span>系统名称</span><i class="fa fa-user-circle">
									</td>
									<td >
										<input class="right" type="text" placeholder="请输入系统名称" name="sysName"  v-model="allData1.sysName">
									</td>
								</tr>
								<tr>
									<td >
										<span>系统简称（登录页名称） </span><i class="fa fa-etsy"></i>
									</td>
									<td >
										<input class="right" type="text" placeholder="请输入系统简称" name="sysSortName"  v-model="allData1.sysSortName">
									</td>
								</tr>
								<tr>
									<td >
										<span>系统版本  </span><i class="fa fa-bookmark-o"></i>
									</td>
									<td >
										<input type="text" class="right" placeholder="请输版本号"  name="version"  lay-filter="version" v-model="allData1.version">
									</td>
								</tr>
								<tr>
									<td >
										<span>系统logo</span><i class="fa fa fa-image"></i>
									</td>
									<td>
										<input  type="hidden" value="上传" name="sysLog" >
										<div class="layui-inline" style="padding:8px 10px;">
											<input type="hidden" name="sysLog" v-model="allData1.sysLog">
											<img id="uploadBtn" class="photo" :src="allData1.sysLog">
										</div>
										<div lass="layui-inline" id="demoText"></div>
									</td>
								</tr>
								<tr>
									<td >
										<span>简介 </span><i class="fa fa-list-alt"></i>
									</td>
									<td style="padding:8px 10px;">
										<script id="editor" type="text/plain" style="min-width:600px;min-height:300px;"></script>
									</td>
								</tr>
							</tbody>
						</table>
						<!-- <div id="testcon" v-html="allData.intro"></div>  -->
					</form>
				</div>
			    <div class="layui-tab-item">
			    	<div class="layui-item" style="text-align:right">
			    		<!-- <button class="layui-btn">修改</button> -->
			    		<button class="layui-btn" @click="saveaSect">保存</button>
			    	</div>
					<form class="layui-form layui-row">
						<table class="layui-table">
							<tbody>
								<tr>
									<td >
										<span>系统管理员</span><i class="fa fa-user-circle">
									</td>
									<td >
										<input class="right" type="text" placeholder="请输入系统管理员" name="sysManagerName"  v-model="allData2.sysManagerName">
									</td>
								</tr>
								<tr>
									<td >
										<span>管理员电话</span><i class="fa fa-etsy"></i>
									</td>
									<td >
										<input class="right" type="text" placeholder="请输入管理员电话" name="sysManagerPhone"  v-model="allData2.sysManagerPhone">
									</td>
								</tr>
								<tr>
									<td >
										<span>管理员email </span><i class="fa fa-bookmark-o"></i>
									</td>
									<td >
										<input type="text" class="right" placeholder="请输入管理员email"  name="sysManagerEmail"  v-model="allData2.sysManagerEmail">
									</td>
								</tr>
								<tr>
									<td >
										<span>用户在线时长</span><i class="fa fa fa-image"></i>
									</td>
									<td>
										<input type="number" class="right" placeholder="请输入用户在线时长"  name="onlineExpress"  v-model="allData2.onlineExpress">
									</td>
								</tr>
								<tr>
									<td >
										<span>支持单点登录 </span><i class="fa fa-list-alt"></i>
									</td>
									<td style="padding:8px 10px;">
										<input type="checkbox" name="singleLogin" lay-skin="switch" lay-filter="singleLoginBox" lay-text="是|否" id="singleLogin">
									</td>
								</tr>
							</tbody>
						</table>
					</form>
			    </div>
			    <div class="layui-tab-item">
			    	<div class="layui-item" style="text-align:right">
			    		<!-- <button class="layui-btn">修改</button> -->
			    		<button class="layui-btn" @click="saveaEmail">保存</button>
			    	</div>
					<form class="layui-form layui-row">
						<table class="layui-table">
							<tbody>
								<tr>
									<td >
										<span>系统邮箱标题</span><i class="fa fa-user-circle">
									</td>
									<td >
										<input class="right" type="text" placeholder="请输入系统邮箱标题" name="pop3Title"  v-model="allData3.pop3Title">
									</td>
								</tr>
								<tr>
									<td >
										<span>发送系统邮件的SMTP服务器</span><i class="fa fa-etsy"></i>
									</td>
									<td >
										<input class="right" type="text" placeholder="请输入发送系统邮件的SMTP服务器" name="smtpServer"  v-model="allData3.smtpServer">
									</td>
								</tr>
								<tr>
									<td >
										<span>系统邮箱POP3帐号</span><i class="fa fa-bookmark-o"></i>
									</td>
									<td >
										<input type="text" class="right" placeholder="请输入系统邮箱POP3帐号"  name="pop3"  v-model="allData3.pop3">
									</td>
								</tr>
								<tr>
									<td >
										<span>系统邮箱POP3密码</span><i class="fa fa fa-image"></i>
									</td>
									<td>
										<input type="password" class="right" placeholder="请输入系统邮箱POP3密码"  name="pop3M"  v-model="allData3.pop3M">
									</td>
								</tr>
								<tr>
									<td >
										<span>最后更新用户 </span><i class="fa fa-list-alt"></i>
									</td>
									<td>
										<input type="text" class="right" name="lastUname" placeholder="请输入最后更新用户" v-model="allData3.lastUname">
									</td>
								</tr>
							</tbody>
						</table>
					</form>
			    </div>
			  </div>
			</div>
		</div>
	</body>


	<script type="text/javascript" src="/assets/common/layui/layui.js"></script>
	<script type="text/javascript" src="/assets/common/vue/vue.js"></script>
	<script type="text/javascript" charset="utf-8" src="/assets/cms/ueditor/ueditor.config.js"></script>
	<script type="text/javascript" charset="utf-8" src="/assets/cms/ueditor/ueditor.all.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="/assets/cms/ueditor/ueditor.all.js"> </script>
	<script type="text/javascript" charset="utf-8" src="/assets/cms/ueditor/lang/zh-cn/zh-cn.js"></script>
	<script>
		var realUrl="${ctx}";
		layui.use(['table', 'form', 'layedit', 'laydate','element','layer','jquery','upload'], function() {
			var table = layui.table;
			var element = layui.element;
			var form = layui.form;
			var layedit = layui.layedit;
			var laydate = layui.laydate;
			var layer = layui.layer;
			var $ = layui.jquery;
			var upload = layui.upload;
			
			form.on('switch(singleLoginBox)', function(data){
		    	  if(data.elem.checked){//开关是否开启，true或者false
		    		  vm.allData2.singleLogin=true;
		    	  }else{
		    		  vm.allData2.singleLogin=false;
		    	  }; 
			});
			
			var vm = new Vue({
				el: '#app',
				data: {
					allData:{},
					allData1:{},
					allData2:{},
					allData3:{}
				},
				created: function() {
					this.getData();
					form.render()
				},
				
				mounted:function(){
					var that = this;
					var uploadInst = upload.render({
					    elem: '#uploadBtn'
					    ,url: '/api/file/ueditor/upload'
					    ,before: function(obj){
					      //预读本地文件示例，不支持ie8
					      obj.preview(function(index, file, result){
					        $('#uploadBtn').attr('src', result); //图片链接（base64）
					      });
					    }
					    ,done: function(res){
					      //如果上传失败
					      console.log(res,"res")
					      if(res.state == 'SUCCESS'){
					    	  console.log(res.url);
					    	  that.allData1.sysLog=res.url;
					    	  return layer.msg('上传成功');
					      }
					      layer.msg('上传失败');
					      //上传成功
					    }
					    ,error: function(){
					      //演示失败状态，并实现重传
					      var demoText = $('#demoText');
					      demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
					      demoText.find('.demo-reload').on('click', function(){
					        uploadInst.upload();
					      });
					    }
					  });
					//文件上传
					var ue = UE.getEditor('editor');
					
					UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;
					//action是config.json配置文件的action
					UE.Editor.prototype.getActionUrl = function(action) {
						if (action == 'uploadimage' || action == 'uploadfile') {
							return '/api/file/ueditor/upload'; //此处改需要把图片上传到中
						} else {
							return this._bkGetActionUrl.call(this, action);
						}
					};
					 window.setTimeout(function(){
						 ue.execCommand('insertHtml', that.allData1.intro);
					 },1000);
					 form.render()
					
				},
				updated:function(){
					form.render();
				},
				methods:{
					getData:function(){
						var that = this;
						var indexclose = layer.load(2, {shade: false}); //0代表加载的风格，支持0-2
						$.ajax({
							url:'/api/sys/info',
							type:'get',
							cache: false,
							data:{timestamp : (new Date()).valueOf()},
							success:function(data){
								layer.close(indexclose);
								if(data.code == 0){
									console.log(data,"data");
									that.allData = data.data;
									//allData1
									Vue.set(that.allData1,'sysName', data.data.sysName);
									Vue.set(that.allData1,'sysSortName', data.data.sysSortName);
									Vue.set(that.allData1,'version', data.data.version);
									Vue.set(that.allData1,'sysLog', data.data.sysLog);
									Vue.set(that.allData1,'intro', data.data.intro);
									
									Vue.set(that.allData2,'sysManagerName', data.data.sysManagerName);
									Vue.set(that.allData2,'sysManagerPhone', data.data.sysManagerPhone);
									Vue.set(that.allData2,'sysManagerEmail', data.data.sysManagerEmail);
									Vue.set(that.allData2,'onlineExpress', data.data.onlineExpress);
									Vue.set(that.allData2,'singleLogin', data.data.singleLogin);
									if(that.allData2.singleLogin==true){
										$('#singleLogin').attr('checked',true)
									}else{
										$('#singleLogin').attr('checked',false)
									}
									Vue.set(that.allData3,'pop3Title', data.data.pop3Title);
									Vue.set(that.allData3,'smtpServer', data.data.smtpServer);
									Vue.set(that.allData3,'pop3', data.data.pop3);
									Vue.set(that.allData3,'pop3M', data.data.pop3M);
									Vue.set(that.allData3,'lastUname', data.data.lastUname);

								}else{
									layer.msg(data.errorMsg);
								}
							},
							error:function(){
								layer.msg("请求出错");
							}
						})
					},
					save:function(){
						var that=this;
						that.allData1.intro=UE.getEditor('editor').getContent();
						var indexclose = layer.msg('数据提交中，请稍候',{icon: 16,time:false,shade:0.8});
						if(that.allData1.sysName==''){
							return layer.msg("系统名不能为空");
						}
						if(that.allData1.sysSortName==''){
							return layer.msg("系统简称不能为空");
						}
						if(that.allData1.version==''){
							return layer.msg("系统版本不能为空");
						}
						$.ajax({
							url:'/api/sys/up',
							type:'post',
							cache: false,
							data:that.allData1,
							success:function(data){
								layer.close(indexclose);
								if(data.code == 0){
									//console.log(data,"data");
									//that.allData = data.data;
									layer.msg('保存成功')
								}else{
									layer.msg(data.errorMsg);
								}
							},
							error:function(){
								layer.msg("请求出错");
							}
						})
					},
					checkTel:function (telphone){
					    var isPhone = /^[1][3,4,5,7,8][0-9]{9}$/
					    var isMob=/^((\+?86)|(\(\+86\)))?(13[012356789][0-9]{8}|15[012356789][0-9]{8}|18[02356789][0-9]{8}|147[0-9]{8}|1349[0-9]{7})$/;
					    if(isMob.test(telphone)||isPhone.test(isPhone)){
					        return true;
					    }
					    else{
					        return false;
					    }
					},
					checkEmail:function(email) {
					    var szReg=/^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/;//
					    if(!szReg.test(email)){
					        $('.regist_errorMsg').find("p").show().html('邮箱格式不正确');
					        return false;
					    }else{
					        return true;
					    }
					},
					saveaSect:function(){
						var that = this;
						var indexclose = layer.msg('数据提交中，请稍候',{icon: 16,time:false,shade:0.8});
						if(that.allData2.sysManagerName==''){
							return layer.msg("系统管理员不能为空");
						}
						if(that.allData2.sysManagerPhone==''){
							return layer.msg("管理员电话不能为空");
						}
						if(!that.checkTel(that.allData2.sysManagerPhone)){
							return layer.msg("管理员电话格式不对");
						}
						if(!that.checkTel(that.allData2.sysManagerPhone)){
							return layer.msg("管理员电话格式不对");
						}
						if(that.allData2.sysManagerEmail!=''&&!that.checkEmail(that.allData2.sysManagerEmail)){
							return layer.msg("管理员邮箱格式不对");
						}
						 $.ajax({
							url:'/api/sys/up',
							type:'post',
							cache: false,
							data:that.allData2,
							success:function(data){
								layer.close(indexclose);
								if(data.code == 0){
									layer.msg('保存成功')
								}else{
									layer.msg(data.errorMsg);
								}
							},
							error:function(){
								layer.msg("请求出错");
							}
						})  
					},
					saveaEmail:function(){
						var that = this;
						var indexclose = layer.msg('数据提交中，请稍候',{icon: 16,time:false,shade:0.8});
						
						console.log(that.allData3,"that.allData3")
						  $.ajax({
							url:'/api/sys/up',
							type:'post',
							cache: false,
							data:that.allData3,
							success:function(data){
								layer.close(indexclose);
								if(data.code == 0){
									layer.msg('保存成功')
								}else{
									layer.msg(data.errorMsg);
								}
							},
							error:function(){
								layer.msg("请求出错");
							}
						}) 
					}
				}//方法结束
			});
		});
		
		
	</script>

</html>